name: Build Blender Intel Dependencies

permissions:
  contents: write

on:
  workflow_dispatch: # Se activa manualmente para no saturar tus minutos
    inputs:
      blender_ref:
        description: 'Rama o tag de Blender a compilar'
        required: true
        default: 'ios'

jobs:
  compile-deps:
    # IMPORTANTE: macos-13 es Intel (x86_64).
    # macos-14 es Apple Silicon (ARM64) y no sirve para lo que necesitas.
    runs-on: macos-13 
    
    steps:
      - name: Checkout Blender
        uses: actions/checkout@v4
        with:
          repository: blender/blender
          ref: ${{ inputs.blender_ref }}
          path: blender # Clonamos en subcarpeta para mantener estructura ../lib
          submodules: false

      - name: Install Build Tools
        run: |
          brew update
          brew install cmake subversion git-lfs bison flex
          git lfs install

      - name: Restore Cache (Opcional pero recomendado)
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: lib/macos_x86_64
          # La clave se basa en el script de instalación. Si cambia, recompila.
          key: blender-deps-intel-${{ hashFiles('blender/build_files/build_environment/install_deps.sh') }}

      - name: Compile Dependencies (make deps)
        if: steps.cache-deps.outputs.cache-hit != 'true'
        working-directory: blender
        # 'make deps' descarga fuentes y compila todo en ../lib/macos_x86_64
        # FORCE_BUILD=1 asegura que no intente descargar binarios inexistentes
        run: |
          make deps \
            BUILD_CMAKE_ARGS="-DOUROBOROS_NETWORK=OFF"

      - name: Verify Output
        run: |
          echo "Verificando existencia de librerías..."
          ls -la lib/macos_x86_64/
          echo "Verificando Python..."
          ls -la lib/macos_x86_64/python/bin/python*

      - name: Compress Dependencies
        run: tar -czf blender_intel_deps.tar.gz lib/macos_x86_64

      # 2. GESTIÓN DEL TAG: Borramos el tag anterior para moverlo al commit actual
      # Esto asegura que la release "latest" contenga el código de HOY.
      - name: Update Tag
        uses: richardsimko/update-tag@v1
        with:
          tag_name: latest-deps
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 3. SUBIDA A RELEASE: Usamos el tag fijo
      - name: Upload to Latest Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest-deps      # Siempre usa este nombre
          name: "Librerías Blender Intel (Última versión)"
          body: "Dependencias compiladas automáticamente. Sobrescrito el: $(date)"
          files: blender_intel_deps.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

