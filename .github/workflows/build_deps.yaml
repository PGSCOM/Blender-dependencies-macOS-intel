name: Build Blender Libraries macOS Intel

on:
  workflow_dispatch:

jobs:
  build-macos-intel-libs:
    runs-on: macos-13  # macOS Intel runner
    permissions:
      contents: write
    
    steps:
    - name: Checkout Blender source
      uses: actions/checkout@v4
      with:
        repository: 'blender/blender'
        ref: 'main'
        submodules: 'recursive'
        fetch-depth: 0

    - name: Clone Blender from official repository
      run: |
        cd ..
        rm -rf blender
        git clone https://projects.blender.org/blender/blender.git blender
        cd blender
        git checkout ios
        git submodule update --init --recursive

    - name: Install dependencies
      run: |
        brew install cmake ninja subversion
        
    - name: Setup directory structure
      run: |
        cd ..
        mkdir -p lib
        
    - name: Download precompiled libraries via SVN with retries
      run: |
        set -euo pipefail
        cd ..
        # ensure a clean start
        rm -rf lib/darwin
        max_attempts=6
        attempt=1
        backoff=15
        while [ $attempt -le $max_attempts ]; do
          echo "Attempt $attempt of $max_attempts: svn checkout..."
          # Increase http timeout, run non-interactive and accept certs; be quiet to reduce logs
          svn checkout --non-interactive --trust-server-cert --quiet --config-option servers:global:http-timeout=600 https://svn.blender.org/svnroot/bf-blender/trunk/lib/darwin lib/darwin && break
          status=$?
          echo "svn checkout failed with exit code $status."
          if [ $attempt -lt $max_attempts ]; then
            echo "Cleaning partial checkout and retrying in $backoff seconds..."
            rm -rf lib/darwin
            sleep $backoff
            backoff=$((backoff * 2))
          else
            echo "Max attempts ($max_attempts) reached. Aborting."
            exit 1
          fi
          attempt=$((attempt + 1))
        done
      continue-on-error: false

    - name: Verify libraries download
      run: |
        if [ -d "../lib/darwin" ]; then
          echo "Libraries downloaded successfully"
          ls -la ../lib/darwin
        else
          echo "Error: Libraries not found"
          exit 1
        fi

    - name: Configure CMake
      run: |
        cd ../blender
        mkdir -p build
        cd build
        cmake .. \
          -G Ninja \
          -DCMAKE_OSX_ARCHITECTURES=x86_64 \
          -DCMAKE_BUILD_TYPE=Release \
          -DLIBDIR=${{ github.workspace }}/../lib/darwin

    - name: Build libraries
      run: |
        cd ../blender/build
        ninja

    - name: Create release archive
      run: |
        cd ..
        tar -czf blender-libs-darwin-intel.tar.gz lib/darwin/
        
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT

    - name: Delete existing latest release
      continue-on-error: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release delete latest --yes --repo ${{ github.repository }}
        git push --delete origin latest || true

    - name: Create latest release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release create latest \
          ../blender-libs-darwin-intel.tar.gz \
          --repo ${{ github.repository }} \
          --title "Latest Blender macOS Intel Libraries" \
          --notes "**Blender Libraries for macOS Intel (x86_64)**
          
          Compiled on: ${{ steps.date.outputs.date }}
          
          These are the precompiled libraries required to build Blender on macOS Intel architecture.
          
          ## Installation
          \`\`\`bash
          # Extract the archive
          tar -xzf blender-libs-darwin-intel.tar.gz
          
          # Use with Blender build
          cmake -DLIBDIR=\$PWD/lib/darwin ...
          \`\`\`
          
          ---
          Built from: https://projects.blender.org/blender/blender" \
          --latest
